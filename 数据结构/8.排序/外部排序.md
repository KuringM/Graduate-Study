# 外部排序

## 外存、内存之间的数据交换

操作系统以"块"为单位对磁盘存储空间进行管理,
如: 每块大小 1KB各个磁盘块内存放着各种各样的数据.

- 磁盘的读/写以"块"为单位,
- 数据读入内存后才能被修改,
- 修改完了还要写回磁盘.

## 外部排序原理

- 数据元素太多, 无法一次全部读入内存进行排序.
- 使用"归并排序"的方法, 最少只需在内存中分配3块大小的缓冲区即可对任意一个大文件进行排序.
- 若要进行k路归并排序, 则需要在内存中分配k个输入缓冲区和1个输出缓冲区

1. 构造初始"归并段": 生成个初始归井段(对L个记录进行内部排序, 组成一个有序的初始归井段)
   > "归并排序"要求各个子序列有序, 每次读入两个块的内容, 进行内部排序后写回磁盘.
2. 进行S躺k路归并, $S= \lceil \log_k r \rceil$

如何进行k路归并

- 把k个归并段的块读入k个输入缓冲区
- 用"归并排序"的方法从k个归并段中选出几个最小记录暂存到输出缓冲区中
- 当输出缓冲区满时, 写出外存

## 时间开销分析

外部排序时间开销=读写外存的时间+内部排序所需时间+内部归并所需时间

- 代价1: 需要增加相应的输入缓冲区
- 代价2: 每次从k个归并段中选一个最小元素需要(k-1)次关键字对比
  > 可用"败者树"減少关键字对比次数

## 如何优化?

多路归并 -- 增加归并路数k, 进行多路平衡归并

![[Pasted image 20250906211259.png]]

减少初始归并段数量r

![[Pasted image 20250906211515.png]]

按照本节介绍的方法生成的初始归并段, 若共 N 个记录, 内存工作区可以容纳 L 个记录, 则初始归并段数量 `r = ⌈N/L⌉`

> 可用"置换-选择排序"进一步减少初始归并段数量

## 纠正: 什么是多路平衡归并?

![[截屏2025-09-06 21.23.32.png]]

![[截屏2025-09-06 21.25.59.png]]

