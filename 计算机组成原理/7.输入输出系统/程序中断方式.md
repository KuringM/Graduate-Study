# 程序中断方式

![[Pasted image 20250827235340.png]]

## 中断的基本概念

程序中断是指在计算机执行现行程序的过程中, 出现某些急需处理的异常情况或特殊请求,
CPU暂时中止现行程序, 而转去对这些异常情况或特殊请求进行处理,
在处理完毕后CPU又自动返回到现行程序的断点处, 继续执行原程序.

## 程序中断的工作流程

1. 中断请求
   - 中断源向CPU发送中断请求信号.
2. 中断响应
   - 响应中断的条件.
   - 中断判优:多个中断源同时提出请求时通过中断判优逻辑响应一个中断源.
3. 中断处理
   - 中断隐指令.
   - 中断服务程序.

## 中断请求的分类

- 内中断(也称异常、例外、陷入)
  > 信号来源: CPU内部与当前执行的指令有关
  - 自愿中断--指令中断, 如: 系统调用时使用的访管指令(又叫陷入指令、trap指令)
  - 强迫中断
    - 硬件故障, 如: 缺页
    - 软件中断, 如: 整数除0
- 外中断(中断
  > 信号来源: CPU外部与当前执行的指令无关
  - 外设请求, 如: IO操作完成发出的中断信号
  - 人工干预, 如: 用户强行终止一个进程
  - 非屏蔽中断:关中断时也会被响应(如:掉电)
  - 可屏蔽中断:关中断时不会被响应

> 关中断的作用:实现原子操作 <BR>
> IF=1表示开中断(允许中断) <BR>
> IF=0表示关中断(不允许中断 <BR>
> IF:Interrupt Flag, 存在PSW中

## 中断请求标记

> 如何判断是哪个设备发来的中断信号?

每个中断源向CPU发出中断请求的时间是随机的. <BR>
为了记录中断事件并区分不同的中断源, 中断系统需对每个中断源设置中断请求标记触发器INTR, 当其状态为"1"时, 表示中断源有请求. <BR>
这些触发器可组成中断请求标记寄存器, 该寄存器可集中在CPU中, 也可分散在各个中断源中.

对于外中断, CPU是在统一的时刻即每条指令执行阶段结束前向接口发出中断查询信号,
以获取I/O的中断请求, 也就是说, CPU响应中断的时间是在每条指令执行阶段的结束时刻.

CPU响应中断必须满足以下3个条件:

1. 中断源有中断请求.
2. CPU允许中断即开中断.
3. 一条指令执行完毕, 且没有更紧迫的任务.

## 中断判优-实现

> 有多个中断信号同时到来, 先处理哪个?

中断判优既可以用硬件实现, 也可用软件实现:

- 硬件实现是通过硬件排队器实现的, 它既可以设置在CPU中, 也可以分散在各个中断源中;
- 软件实现是通过查询程序实现的.

## 中断判优-优先级设置

1. 硬件故障中断属于最高级, 其次是软件中断;
2. 非屏蔽中断优于可屏蔽中断;
3. DMA请求优于I/O设备传送的中断请求
4. 高速设备优于低速设备;
5. 输入设备优于输出设备;
6. 实时设备优于普通设备.

## 中断处理过程

![[Pasted image 20250827231724.png]]

### 中断处理过程-中断隐指令

![[Pasted image 20250827231920.png]]

### 中断处理过程-硬件向量法

![[Pasted image 20250827232631.png]]

### 中断处理过程-中断服务程序

![[Pasted image 20250827232957.png]]

## 多重中断

![[Pasted image 20250827234004.png]]

## 中断屏蔽技术

中断屏蔽技术主要用于多重中断, CPU要具备多重中断的功能, 须满足下列条件.

1. 在中断服务程序中提前设置开中断指令.
2. 优先级别高的中断源有权中断优先级别低的中断源.

每个中断源都有一个屏蔽触发器, 1表示屏蔽该中断源的请求, 0表示可以正常申请, 所有屏蔽触发器组合在一起, 便构成一个屏蔽字寄存器, 屏蔽字寄存器的内容称为屏蔽字.

屏蔽字设置的规律:

1. 一般用'1'表示屏蔽, '0'表示正常申请.
2. 每个中断源对应一个屏蔽字(在处理该中断源的中断服务程序时, 屏蔽寄存器中的内容为该中断源对应的屏蔽字).
3. 屏蔽字中'1'越多, 优先级越高. 每个屏蔽字中至少有一个'1'(至少要能屏蔽自身的中断).
