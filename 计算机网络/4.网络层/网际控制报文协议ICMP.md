# 网际控制报文协议ICMP( Internet Control Message Protocol )

![[IPv4分组#各种协议之间的服务关系]]

- ICMP属于**网络层**, ICMP报文封装在IP数据报中.
- ICMP可以让主机或路由器互相报告网络中发生的差错和异常情况.

## ICMP报文的常见类型

1. 差错报告报文
2. 询问报文

### ICMP报文、IP数据报之间的关系

![[Pasted image 20250830053818.png]]

### 差错报告报文的5种报文类型

- **终点不可达**
  - 路由器告诉发送方: "目的IP地址不可到达" -- **道路不通**
  - 目的主机告诉发送方: "目的端口号不存在, 我这边没有对应进程"
- **时间超过**
  - 路由器告诉发送方: "你的IP数据报到我这里 `TTL=0` , 被我丢了" -- **路程太远**
  - 目的主机告诉发送方: "你的IP数据报被分片了, 规定时间内没到齐, 我已全部丢弃"
- **参数问题**
  - 告诉发送方: "你的IP数据报首部参数不合法、或首部校验出错"
- **改变路由(重定向)**
  - 路由器告诉发送方: "对于这个目的网络, 下次你让另一台路由器帮你转发, 路径会更短"
- 源点抑制(2012年后已废弃)
  - 告诉发送方: "网络发生拥塞, 丢包了, 求求你发慢点" (通常交给上层的TCP完成)

### 询问报文的2种报文类型

> 成对出现

- 回送请求和回答报文
  - **回送请求** (Echo Request) -- A->B: 在吗?回答我!
  - **回送回答** (Echo Reply) -- B->A: 在!
- 时间戳请求和回答报文
  - **时间戳请求** (Timestamp Request) -- A->B: 我这边现在的时间是xxxx, 你那边几点了?
  - **时间戳回答** (Timestamp Reply) -- B->A: 我收到请求的时间是yyyy, 我发出回答的时间是zzzz

## 不必反馈ICMP差错报告报文的情况

- 若携带ICMP差错报告报文的IP数据报出错, 不再反馈ICMP差错
- 若IP数据报被分片, 则无论几个分片出错, 都只反馈一次ICMP差错
- 若IP数据报的目的地址为多播地址, 不反馈ICMIP差错
- 若IP数据报的源地址为特殊地址(如: 127.X.X.X、0.0.0.0), 则即便发生IP数据报异常也不反馈ICMP差错

## ICMP的典型应用

- **ping** 基于 _回送请求报文、回送回答报文_ 实现功能
- **traceroute** (tracert)基于 _时间超过报文_ 实现功能
