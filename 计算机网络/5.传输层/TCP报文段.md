# TCP报文段

> TCP报文段(另译**TCP段**, TCP segment -- TCP段)

## TCP协议的三大阶段:

1. 建立连接(三次握手)
2. 数据传输
3. 释放连接(四次挥手)

![[截屏2025-08-30 11.22.11.png]]

### 建立一次TCP连接可以传输多个报文

![[截屏2025-08-30 11.28.30.png]]

## TCP段格式 ‼️

![[截屏2025-08-30 11.35.08.png]]
![[截屏2025-08-30 12.02.15.png]]

- 第一行32bit(4B): **端口号**
  - 发送方进程的端口号(2B)、接收方进程的端口号(2B)
- 第二行: **序号(seq)** ‼️
  - 用于标记数据部分第一个字节在原始字节流中的位置
  - 起始序号是发送方自己设置的, 不一定从0开始
  - 序号在真题中常简记为小写的seq
- 第三行: **确认号(ack/ack_seq)** ‼️
  - 用于反馈、表示序号(seq)在该确认号之前的所有字节都已正确收到 -- 累计确认
  - 确认号在真题中常简记为小写ack或ack_seq
- 第四行:
  - **确认位ACK** -- 1bit(记为大写ACK) ‼️
    - ACK=0时, ack_seq无效
    - ACK=1时, ack_seq有效
    - 只有握手1的ACK=0, 其他所有TCP报文段ACK=1
  - **数据偏移(Data Offset)** -- 4bit, _表示TCP首部长度_, 以`x4B`为单位
    - 在TCP首部中, 并不会专门记录TCP数据部分长度(会根据IP首部、TCP首部的信息算出来)
  - **保留** -- 6bit, 暂时没啥用, 通常全部置为0
  - **紧急位URG**(urgent) -- 1bit, URG=1时, 紧急指针有效. 表示这是紧急数据, 应尽快插队发送
  - **推送位PSH**(Push) -- 1bit, PSH=1时, 表示希望接收方尽快回复(用于交互式通信)
  - **复位位RST**(Reset) -- 1bit, RST=1时, 表示出现严重差错(如主机崩溃), 必须释放连接. 也可用于拒绝一个非法报文段(如恶意的黑客攻击)
  - **同步位SYN**(synchronize) -- 1bit, 当 SYN =1 时表示这是一个连接请求或连接接受报文. ‼️
    - 只有握手1、握手2的SYN=1, 其他所有TCP报文段都是SYN=0
  - **终止位FIN**(Finish) -- 1bit, 当 FIN=1 时, 表明此报文段的发送方的数据已发送完毕, 要求释放传输连接. ‼️
    - 只有挥手1、挥手3的FIN=1, 其他所有TCP报文段都是FIN=0
  - **窗口(rwnd/rcvwnd)**(receive window) - 16bit, 表示接收窗口的大小. 即从本报文段首部中的ack_seq算起, 接收方还能接收多少数据(以字节为单位) ‼️
    - 这个字段是实现**流量控制**的关键
    - 窗口在真题中常简记为rwnd或 rcvwnd
- 第五行:
  - **检验和** -- 原理与UDP雷同, 计算检验和之前也需要添加12B 伪首部(只需将UDP伪首部的协议字段的17改成6, UDP长度字段改成TCP长度)
  - **紧急指针** -- 2B, 紧急数据专用序号, 原理与上面那个**序号**字段相同
- 第六行:
  - **选项** -- 长度可变, 最长40B. 也可以非空.
    - 建立TCP连接时, 在握手1、握手2选项中协商**MSS**( Maximum Segment Size, 最大段长) ‼️
    - MSS的值表示在接下来的数据传输中, 一个TCP报文段最多携带多少数据(首部不算在内)
    - 通常MSS不会设置太大, 以免在IP层被分片
  - **填充** -- 为了使整个首部长度是4B的整数倍
