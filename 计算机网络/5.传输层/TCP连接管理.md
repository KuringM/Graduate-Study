# TCP连接管理

三次握手、四次挥手

- SYN、ACK、FIN、seq、ack_seq 的值为多少?
- 每发出/收到一个握手/挥手报文段后, 进程的**TCP状态转换**
- 建立连接、断开连接的最短**耗时分析**

## 建立连接(三次握手)

![[Pasted image 20250830131018.png]]

- **只有握手1的ACK=0, 其他所有TCP报文段都是ACK=1**
- **只有握手1、2的SYN=1, 其他所有TCP报文段都是SYN=0**

![[Pasted image 20250830132305.png]]

- 握手1、2不能携带数据, 握手3可以携带数据
- 握手1、2固定消耗1个序号
- 握手3如果不携带数据就不消耗序号
- 握手3如果携带nB数据就消耗n个序号

![[Pasted image 20250830131230.png]]

- 从发出握手1, 到客户端进程可以发送数据, 至少需要多久? -- 1RTT
- 从发出握手1, 到服务器进程可以发送数据, 至少需要多久? -- 1.5RTT

## 释放连接(四次挥手)

![[Pasted image 20250830134022.png]]

- **只有挥手1、3的FIN=1, 其他所有TCP报文段都是FIN=0**
- 挥手1、挥手3即使不携带数据, 也要消耗一个序号
- 挥手2可以携带数据
- 挥手4不可以携带数据

![[截屏2025-08-30 13.44.13.png]]

- 客户进程收到挥手3后, 立即进入TIME-WAIT状态, 并启动"TIME-WAIT计时器", 倒计时2MSL后才能进入CLOSE状态.
  > 如CLOSE-WAIT关闭等待果等待期间重复收到挥手3, 就重置计时器
- **MSL**(Maximum Segment Lifetime, 最长报文段寿命), 是由TCP协议规定的一个固定时间长度

![[截屏2025-08-30 13.57.26.png]]

- 如果服务器进程收到挥手1时, 已经没有待传送数据, 那么可以连续发出挥手2、挥手3
- CLOSE-WAIT关闭等待极短暂, 接近0, FIN-WAIT-2终止等待2极短暂, 接近0
- 从客户发出挥手1, 到客户进程进入CLOSE状态, 至少需要多久? -- 1RTT+2MSL
- 从客户发出握手1, 到服务器进程进程进入CLOSE状态, 至少需要多久? -- 1.5RTT

## 建立连接要点总结

- 握手1、2(SYN段)不能携带数据, 也要消耗1个序号
- 握手3可以携带数据(如果不携带数据就不消耗序号)
- 耗时分析 -Key:客户收到握手2就可以开始传送数据, 服务器收到握手3才能传送数据

## 释放连接要点总结

- 挥手1、3(FIN段)即使不携带数据, 也要消耗一个序号
- 挥手2可以携带数据, 挥手4;不可以携带数据

耗时分析

- Key
  - 客户进程收到挥手3后, 至少要例计时2MSL后才能进入CLOSE状态
  - 如果服务器进程收到挥手1时, 已经没有待传送数据, 那么可以连续发出挥于2、3)
- MSL(最长报文段寿命), 是由TCP协议规定的一个固定时间长度

> 备忘-考前几天记得回顾建立连接、释放连接阶段的"状态变化"
