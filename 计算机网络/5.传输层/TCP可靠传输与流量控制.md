# TCP可靠传输与流量控制

## TCP传输的底层原理

![[Pasted image 20250830141516.png]]

一个端口可以建立多个TCP连接

- ⼀个端⼝可以建⽴多个TCP连接, 但每个TCP连接仅⽀持⼀对⼀通信(全双⼯)
- TCP协议的发送缓冲区、接收缓冲区在操作系统内核区. 在建⽴连接时由操作系统分配⼤⼩

### 确认号、接收窗口大小

![[Pasted image 20250830141151.png]]

### 累积确认

![[Pasted image 20250830141300.png]]

### 捎带确认

![[Pasted image 20250830144731.png]]

### 超时重传机制

![[Pasted image 20250830155759.png]]

![[Pasted image 20250830155936.png]]

### 快重传机制、立即确认机制

![[Pasted image 20250830161813.png]]

## TCP可靠传输

**序号** -- 进程在建立连接时确定起始序号, 数据传输过程中, 每个字节对应一个序号

**确认机制**

- 累积确认规则 -- 如果收到 ack_seq=n, 说明序号在n之前的所有字节都已正确接收
- 返回ACK的时机 -- **推迟确认**
  - 推迟时间最多不能超过0.5秒(TCP标准规定)
  - 如果自己也有数据要传送给对方, 立即返回ACK段, 并"捎带"自己的数据
  - 若连续收到两个长度为MSS的报文段, 就应该立即返回ACK段
- 两种ACK段
  - 专门确认(咸鱼不规范术语) -- 一个ACK段只有TCP首部, 而没有携带数据
  - _捎带确认_ -- 一个ACK段顺道携带了数据, 就是"捎带确认"

重传机制

- 超时重传 -- 每发出一个报文段, 就设置一个计时器. 若计时器到期还没收到确认, 就重传这一报文段, 并重置计时器
- 快重传(冗余ACK)
  - 作用:让可能出错的报文段尽早重传, 而不是非要等到超时再重传
  - 配套机制 -- **立即确认**
    - 每收到一个TCP报文段, 就立即返回一个ACK段
    - 即使收到一个失序报文段, 也要立即返回ACK段(失序报文段会导致冗余ACK)
  - 当发送方连续收到*三个确认号相同的冗余ACK*时, 就立即重传该确认号对应的报文段
    > 注意: 应该理解为连续收到1+3个确认号相同的ACK(后三个属于冗余ACK)

## TCP流量控制(滑动窗口)

接收方维持一个接收窗口(记为 rcvwnd 或rwnd)

- 接收窗口不能大于接收缓冲区大小
- 接收窗口"框柱"的是接收方还允许接收的序号范围

发送方维持一个发送窗口

- 发送窗口不能大于发送缓冲区大小
- 发送窗口不能大于接受窗口的大小
- 发送窗口"框住"的是发送缓冲区中, 已发送但尚未收到确认的数据, 以及可以发送但尚未发送的数据
