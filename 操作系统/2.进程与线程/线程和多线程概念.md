# 线程和多线程概念

## 什么是线程, 为什么要引入线程?

- 可以把线程理解为"轻量级进程".
- 线程是一个基本的CPU执行单元, 也是程序执行流的最小单位.
- 引入线程之后, 不仅是进程之间可以并发, 进程内的各线程之间也可以并发, 从而进一步提升了系统的并发度, 使得一个进程内也可以并发处理各种任务(如QQ视频、文字聊天、传文件)
- 引入线程后, 进程只作为除CPU之外的系统资源的分配单元(如打印机、内存地址空间等都是分配给进程的).
- 线程则作为处理机的分配单元.

## 引入线程机制后, 有什么变化?

- 资源分配、调度
  - 传统进程机制中, 进程是资源分配、调度的基本单位
  - 引入线程后, 进程是资源分配的基本单位, 线程是调度的基本单位
- 井发性
  - 传统进程机制中, 只能进程间并发
  - 引入线程后, 各线程间也能并发, 提升了并发度
- 系统开销
  - 传统的进程间并发, 需要切换进程的运行环境, 系统开销很大
  - 线程间并发, 如果是同一进程内的线程切换, 则不需要切换进程环境, 系统开销小
  - 引入线程后, 并发所带来的系统开销减小

## 线程的实现方式

1. 用户级线程由应用程序通过线程库实现, 所有的线程管理工作都由应用程序负责(包括线程切换)
2. 用户级线程中, 线程切换可以在用户态下即可完成, 无需操作系统干预.
3. 在用户看来, 是有多个线程. 但是在操作系统内核看来, 并意识不到线程的存在. "用户级线程"就是"从用户视角看能看到的线程"
4. 优缺点
   - 优点: 用户级线程的切换在用户空间即可完成, 不需要切换到核心态, 线程管理的系统开销小, 效率高
   - 缺点: 当一个用户级线程被阻塞后, 整个进程都会被阻塞, 并发度不高. 多个线程不可在多核处理机上并行运行.

## 多线程模型

一对一模型: 一个用户级线程映射到一个内核级线程. 每个用户进程有与用户级线程同数量的内核级线程.

- 优点: 当一个线程被阻塞后, 别的线程还可以继续执行, 并发能力强. 多线程可在多核处理机上并行执行.
- 缺点: 一个用户进程会占用多个内核级线程, 线程切换由操作系统内核完成, 需要切换到核心态, 因此线程管理的成本高, 开销大.

多对一模型: 多个用户级线程映射到一个内核级线程. 且一个进程只被分配一个内核级线程.

- 优点: 用户级线程的切换在用户空间即可完成, 不需要切换到核心态, 线程管理的系统开销小, 效率高
- 缺点: 当一个用户级线程被阻塞后, 整个进程都会被阻塞, 并发度不高. 多个线程不可在多核处理机上并行运行

多对多模型: n 用户及线程映射到 m 个内核级线程(n >= m). 每个用户进程对应 m 个内核级线程.
克服了多对一模型并发度不高的缺点(一个阻塞全体阻塞), 又克服了一对一模型中一个用户进程占用太多内核级线程, 开销太大的缺点.

## 线程的状态与转换

![[Pasted image 20251007150612.png]]

