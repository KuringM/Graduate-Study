# 处理器运行模式

## 内核程序 v.s. 应用程序 && 特权指令 v.s. 非特权指令

程序运行的过程其实就是CPU执行一条一条的机器指令的过程.

应用程序只能使用**非特权指令**, 如: 加法指令、减法指令等.

操作系统内核作为 **管理者**, 有时会让CPU执行一些**特权指令**,
如: 内存清零指令. 这些指令影响重大, 只允许**管理者** -- 即操作系统内核来使用.

## 内核态 v.s. 用户态

CPU 能判断出指令类型, 但是它怎么区分此时正在运行的是内核程序 or 应用程序?

CPU 有两种状态, **内核态**和**用户态**

- 处于内核态时, 说明此时正在运行的是内核程序, 此时可以执行特权指令
- 处于用户态时, 说明此时正在运行的是应用程序, 此时只能执行非特权指令

如何实现CPU状态的切换?

- 拓展: CPU 中有一个寄存器叫 程序状态字寄存器(PSW), 其中有个二进制位, 1表示 **内核态**, 0表示**用户态**
- 别名: 内核态=核心态=管态;用户态=目态

### 内核态、用户态 的切换

- 内核态 -> 用户态: 执行一条特权指令 -- 修改PSW的标志位为**用户态**, 这个动作意味着操作系统将主动让出CPU使用权
- 用户态 -> 内核态: 由**中断**引发, 硬件自动完成变态过程, 触发中断信号意味着操作系统将强行夺回CPU的使用权

除了非法使用特权指令之外, 还有很多事件会触发中断信号.
一个共性是, 但凡需要操作系统介入的地方, 都会触发中断信号.

操作系统内核在让出CPU之前, 会用一条特权指令把 PSW 的标志位设置为"用户态".

CPU检测到中断信号后, 会立即变为"核心态", 并停止运行当前的应用程序, 转而运行处理中断信号的内核程序.
